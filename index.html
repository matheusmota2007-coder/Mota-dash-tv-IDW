<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Mota Dash TV ‚Äì Multi Links</title>
  
  <style>
    html,body{height:100%;margin:0;background:#05070c;color:#eaeaf0;font-family:Inter,Arial,sans-serif;overflow:hidden;}
    #app{position:fixed;inset:0;display:flex;flex-direction:column;}
    #header{padding:16px 20px 10px;display:flex;justify-content:space-between;align-items:flex-end;gap:14px;background:rgba(0,0,0,.35);backdrop-filter:blur(6px);}
    #title{font-size:22px;font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:68vw;}
    #meta{font-size:13px;opacity:.78;white-space:nowrap;text-align:right;}
    #chartWrap{position:relative;flex:1;min-height:0;}
    #chart{position:absolute;inset:0;}
    #msg{position:absolute;inset:0;display:none;align-items:center;justify-content:center;text-align:center;padding:26px;white-space:pre-wrap;background:rgba(0,0,0,.72);z-index:9;font-size:14px;line-height:1.35;}
    #progressWrap{height:6px;background:rgba(255,255,255,.12);}
    #progress{height:100%;width:100%;background:linear-gradient(90deg,#4f7cff,#24d3ee);transform-origin:left;transform:scaleX(1);}
    .nav-btn{position:fixed;bottom:12px;width:54px;height:54px;border-radius:999px;border:1px solid rgba(255,255,255,.16);background:rgba(0,0,0,.35);color:rgba(255,255,255,.92);font:26px Arial,sans-serif;line-height:54px;text-align:center;z-index:20;user-select:none;-webkit-tap-highlight-color:transparent;}
    .nav-btn:active{transform:scale(.96);}
    #prev{left:12px;} #next{right:12px;}
    #perfIndicator{position:fixed;top:10px;right:10px;padding:4px 10px;background:rgba(0,0,0,.6);border-radius:12px;font-size:11px;z-index:25;opacity:.7;}
    .perf-low{color:#ff6b6b;} .perf-high{color:#51cf66;}
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
</head>

<body>
<div id="app">
  <div id="header">
    <div id="title">Carregando‚Ä¶</div>
    <div id="meta"></div>
  </div>
  <div id="chartWrap">
    <div id="chart"></div>
    <div id="msg"></div>
  </div>
  <div id="progressWrap"><div id="progress"></div></div>
</div>

<div class="nav-btn" id="prev" title="Anterior">‚óÄ</div>
<div class="nav-btn" id="next" title="Pr√≥ximo">‚ñ∂</div>
<div id="perfIndicator"></div>

<script>
/* =========================
   DETEC√á√ÉO DE PERFORMANCE
========================= */
function detectPerformanceMode(){
  const checks = {
    lowMemory: navigator.deviceMemory && navigator.deviceMemory <= 4,
    lowCores: navigator.hardwareConcurrency && navigator.hardwareConcurrency <= 2,
    isMobile: /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),
    isTVBox: /TV|SmartTV|AFTT|AFTM|AFTB|AFT/i.test(navigator.userAgent),
    slowConnection: navigator.connection && (navigator.connection.effectiveType === 'slow-2g' || navigator.connection.effectiveType === '2g')
  };
  
  // Se detectar qualquer sinal de hardware limitado, usa modo de baixa performance
  const isLowPerf = checks.lowMemory || checks.lowCores || checks.isTVBox || checks.slowConnection;
  
  return {
    mode: isLowPerf ? 'low' : 'high',
    details: checks
  };
}

const PERF = detectPerformanceMode();

// Mostrar indicador de modo
const perfIndicator = document.getElementById('perfIndicator');
if(PERF.mode === 'low'){
  perfIndicator.className = 'perf-low';
  perfIndicator.textContent = '‚ö° Modo Otimizado';
} else {
  perfIndicator.className = 'perf-high';
  perfIndicator.textContent = 'üöÄ Modo Performance';
}

/* =========================
   CONFIG
========================= */
const SOURCES = [
  {
    name: "Maquina de costura",
    csvUrl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSePvDhgfqtEf49n0yzoxCYmzR53HTyvrJQ9a4gf8T03-cpkSPoH1rwlACeeDVeLpMIqmnHDJnHU4wY/pub?gid=806509342&single=true&output=csv"
  },
  {
    name: "Corte",
    csvUrl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRnL9qLyOpMIB4Sko6Dk0Vz1sRgdUhCy9bVz1Kd30dmAjqOlxxwpCO2yVcV9dX8wVWW9OrhdMbEc4jT/pub?gid=279273967&single=true&output=csv"
  },
];

// Configura√ß√µes adaptativas baseadas em performance
const LAST_DAYS = PERF.mode === 'low' ? 15 : 30;
const INTERVAL_MS = PERF.mode === 'low' ? 45_000 : 30_000;

/* =========================
   UI
========================= */
const elTitle = document.getElementById("title");
const elMeta  = document.getElementById("meta");
const elMsg   = document.getElementById("msg");
const elProg  = document.getElementById("progress");

function showMsg(txt){ elMsg.style.display="flex"; elMsg.textContent=txt; }
function hideMsg(){ elMsg.style.display="none"; elMsg.textContent=""; }

/* =========================
   CSV parser (aspas)
========================= */
function parseCSV(text){
  const rows=[]; let row=[]; let cur=""; let inQuotes=false;
  for(let i=0;i<text.length;i++){
    const c=text[i], next=text[i+1];
    if(c==='"' && inQuotes && next==='"'){ cur+='"'; i++; continue; }
    if(c==='"'){ inQuotes=!inQuotes; continue; }
    if(!inQuotes && (c==="\n"||c==="\r")){
      if(c==="\r" && next==="\n") i++;
      row.push(cur); rows.push(row); row=[]; cur=""; continue;
    }
    if(!inQuotes && c===","){ row.push(cur); cur=""; continue; }
    cur+=c;
  }
  if(cur.length || row.length){ row.push(cur); rows.push(row); }
  return rows.filter(r => r.some(x => String(x??"").trim()!==""));
}

function normHeader(s){
  return String(s??"").trim().toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .replace(/[^\w\s]/g," ").replace(/\s+/g," ").trim();
}

function parsePercentOrNumber(v){
  const s=String(v??"").trim(); if(!s) return null;
  if(s.endsWith("%")){
    const raw=s.slice(0,-1).trim();
    const n=parsePercentOrNumber(raw);
    return n==null?null:n;
  }
  const norm=s.replace(/\./g,"").replace(",",".");
  const n=Number(norm);
  return Number.isFinite(n)?n:null;
}

function parseDDMMYYYY(v){
  const s=String(v??"").trim();
  const m=s.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
  if(!m) return null;
  return new Date(Date.UTC(+m[3], +m[2]-1, +m[1], 12,0,0));
}

function parseHMS(v){
  const s=String(v??"").trim();
  const m=s.match(/^(\d{1,3}):(\d{2}):(\d{2})$/);
  if(!m) return null;
  const hh=+m[1], mm=+m[2], ss=+m[3];
  if(![hh,mm,ss].every(Number.isFinite)) return null;
  return hh*3600+mm*60+ss;
}

function fmtDateShort(d){
  const dd=String(d.getUTCDate()).padStart(2,"0");
  const mm=String(d.getUTCMonth()+1).padStart(2,"0");
  return `${dd}/${mm}`;
}

function fmtInt(n){ return (n==null) ? "" : Math.round(n).toLocaleString("pt-BR"); }
function fmt1(n){ return (n==null) ? "" : (Math.round(n*10)/10).toLocaleString("pt-BR"); }
function fmt2(n){ return (n==null) ? "" : (Math.round(n*100)/100).toLocaleString("pt-BR"); }

/* =========================
   LOAD MASTER per SOURCE
========================= */
async function loadMasterFrom(csvUrl){
  const u=new URL(csvUrl);
  u.searchParams.set("_", Date.now().toString());
  const resp=await fetch(u.toString(), {cache:"no-store"});
  if(!resp.ok) throw new Error(`Falha ao buscar CSV (${resp.status})`);
  const text=await resp.text();
  const rows=parseCSV(text);
  if(rows.length<2) throw new Error("CSV vazio.");

  const header=rows[0].map(normHeader);
  function colIndex(...aliases){
    for(const a of aliases){
      const i=header.indexOf(normHeader(a));
      if(i>=0) return i;
    }
    return -1;
  }

  const cData  = colIndex("data");
  const cPar   = colIndex("parado");
  const cFunc  = colIndex("funcionando");
  const cTC    = colIndex("tc medio");
  const cPecas = colIndex("pecas fabric", "pecas fabricadas", "pecas fabric");
  const cUtil  = colIndex("utilizacao de maquina", "utilizacao maquina", "utilizacao");
  const cEf5   = colIndex("eficiencia -5 dias media", "eficiencia 5 dias media", "eficiencia 5 dias");

  if(cData<0) throw new Error("Coluna 'data' n√£o encontrada.");

  const out=[];
  for(let r=1;r<rows.length;r++){
    const row=rows[r];
    const d=parseDDMMYYYY(row[cData]);
    if(!d) continue;

    const parado_s = cPar>=0 ? parseHMS(row[cPar]) : null;
    const func_s   = cFunc>=0? parseHMS(row[cFunc]): null;

    out.push({
      date:d,
      label:fmtDateShort(d),
      util:  cUtil>=0 ? parsePercentOrNumber(row[cUtil]) : null,
      ef5:   cEf5>=0  ? parsePercentOrNumber(row[cEf5])  : null,
      pecas: cPecas>=0? parsePercentOrNumber(row[cPecas]): null,
      tc_s:  cTC>=0   ? parseHMS(row[cTC])               : null,
      func_h: (func_s==null?null:func_s/3600),
      parado_h: (parado_s==null?null:parado_s/3600),
    });
  }

  out.sort((a,b)=>a.date.getTime()-b.date.getTime());
  const sliced = out.slice(-LAST_DAYS);
  if(!sliced.length) throw new Error("Sem dados v√°lidos de data.");
  return sliced;
}

/* =========================
   ECHARTS helpers (ADAPTATIVO)
========================= */
function baseOption(master){
  const isLowPerf = PERF.mode === 'low';
  
  return {
    backgroundColor:"transparent",
    animation: !isLowPerf,
    animationDuration: isLowPerf ? 0 : 1200,
    animationEasing: isLowPerf ? "linear" : "cubicOut",
    textStyle:{color:"#eaeaf0"},
    grid:{left:56,right:18,top:36,bottom:44},
    tooltip:{
      trigger:"axis",
      backgroundColor:"rgba(10,14,25,0.92)",
      borderColor:"rgba(255,255,255,0.08)",
      borderWidth:1,
      textStyle:{color:"#fff"},
      axisPointer:{type:"line"}
    },
    xAxis:{
      type:"category",
      data:master.map(x=>x.label),
      axisLine:{lineStyle:{color:"rgba(255,255,255,0.18)"}},
      axisTick:{show:false},
      axisLabel:{color:"rgba(255,255,255,0.72)"}
    },
    yAxis:{
      type:"value",
      axisLine:{show:false},
      axisTick:{show:false},
      axisLabel:{color:"rgba(255,255,255,0.72)"},
      splitLine:{lineStyle:{color:"rgba(255,255,255,0.06)"}}
    }
  };
}

function gradientArea(top, bottom){
  if(PERF.mode === 'low'){
    // Modo otimizado: cor s√≥lida ao inv√©s de gradiente
    return top.replace(/[\d.]+\)$/, '0.2)'); // reduz opacidade
  }
  // Modo high performance: gradiente completo
  return new echarts.graphic.LinearGradient(0,0,0,1,[
    {offset:0,color:top},{offset:1,color:bottom}
  ]);
}

function gradientBar(top, bottom){
  if(PERF.mode === 'low'){
    return top; // cor s√≥lida
  }
  return new echarts.graphic.LinearGradient(0,0,0,1,[
    {offset:0,color:top},{offset:1,color:bottom}
  ]);
}

function lineEndLabel(master, fmtFn, suffix=""){
  return {
    show:true, position:"top", distance:6,
    color:"rgba(255,255,255,0.92)", fontSize:13, fontWeight:700,
    formatter:(p)=> (p.dataIndex===master.length-1) ? `${fmtFn(p.value)}${suffix}` : ""
  };
}

function lineAllLabels(fmtFn, suffix=""){
  return {
    show:true,
    position:"top",
    distance:6,
    color:"rgba(255,255,255,0.90)",
    fontSize:11,
    fontWeight:700,
    formatter:(p)=>{
      if(p.value == null || p.value === "" || Number.isNaN(p.value)) return "";
      return `${fmtFn(p.value)}${suffix}`;
    }
  };
}

function barTopLabel(fmtFn, suffix=""){
  return {
    show:true,
    position:"top",
    color:"rgba(255,255,255,0.90)",
    fontSize:12,
    fontWeight:700,
    formatter:(p)=> `${fmtFn(p.value)}${suffix}`
  };
}

function stackInsideLabel(fmtFn, suffix=""){
  return {
    show:true,
    position:"inside",
    color:"rgba(255,255,255,0.92)",
    fontSize:12,
    fontWeight:700,
    formatter:(p)=> `${fmtFn(p.value)}${suffix}`
  };
}

/* =========================
   5 gr√°ficos por fonte (template)
========================= */
function buildFiveScreensForSource(sourceIndex){
  const src = SOURCES[sourceIndex];
  const master = DATA_BY_SOURCE[sourceIndex];
  const isLowPerf = PERF.mode === 'low';

  return [
    {
      title: `${src.name} ‚Ä¢ Utiliza√ß√£o da M√°quina (%)`,
      option: () => {
        const opt = baseOption(master);
        opt.yAxis.min=0; opt.yAxis.max=100;
        opt.series=[{
          name:"Utiliza√ß√£o (%)",
          type:"line",
          smooth: !isLowPerf,
          showSymbol:true,
          symbol:"circle",
          symbolSize: isLowPerf ? 3 : 5,
          connectNulls:true,
          lineStyle:{width: isLowPerf ? 2 : 3},
          areaStyle:{color:gradientArea("rgba(79,124,255,0.33)","rgba(79,124,255,0.03)")},
          label: lineAllLabels(fmt2, "%"),
          data: master.map(x=>x.util)
        }];
        return opt;
      }
    },
    {
      title: `${src.name} ‚Ä¢ Efici√™ncia (m√©dia 5 dias) (%)`,
      option: () => {
        const opt = baseOption(master);
        opt.yAxis.min=0; opt.yAxis.max=100;
        opt.series=[{
          name:"Efici√™ncia 5d (%)",
          type:"line",
          smooth: !isLowPerf,
          showSymbol:true,
          symbol:"circle",
          symbolSize: isLowPerf ? 3 : 5,
          connectNulls:true,
          lineStyle:{width: isLowPerf ? 2 : 3},
          areaStyle:{color:gradientArea("rgba(36,211,238,0.28)","rgba(36,211,238,0.03)")},
          label: lineAllLabels(fmt2, "%"),
          data: master.map(x=>x.ef5)
        }];
        return opt;
      }
    },
    {
      title: `${src.name} ‚Ä¢ Pe√ßas produzidas (dia)`,
      option: () => {
        const opt = baseOption(master);
        opt.series=[{
          name:"Pe√ßas",
          type:"bar",
          barWidth:"55%",
          itemStyle:{
            borderRadius: isLowPerf ? [6,6,0,0] : [10,10,0,0],
            color: gradientBar("rgba(79,124,255,0.95)", "rgba(79,124,255,0.25)")
          },
          label: barTopLabel(fmtInt),
          data: master.map(x=>x.pecas)
        }];
        return opt;
      }
    },
    {
      title: `${src.name} ‚Ä¢ Tempo de ciclo m√©dio (s)`,
      option: () => {
        const opt = baseOption(master);
        opt.series=[{
          name:"TC m√©dio (s)",
          type:"line",
          smooth: !isLowPerf,
          showSymbol:true,
          symbol:"circle",
          symbolSize: isLowPerf ? 3 : 5,
          connectNulls:true,
          lineStyle:{width: isLowPerf ? 2 : 3, color:"rgba(255,255,255,0.85)"},
          label: lineAllLabels(fmtInt, "s"),
          data: master.map(x=>x.tc_s)
        }];
        return opt;
      }
    },
    {
      title: `${src.name} ‚Ä¢ Parado vs Funcionando (h)`,
      option: () => {
        const opt = baseOption(master);
        opt.legend={top:6,textStyle:{color:"rgba(255,255,255,0.78)"}};
        opt.yAxis.min=0;
        opt.series=[
          {
            name:"Funcionando (h)",
            type:"bar",
            stack:"total",
            barWidth:"55%",
            itemStyle:{
              borderRadius: isLowPerf ? [6,6,0,0] : [10,10,0,0],
              color:"rgba(36,211,238,0.85)"
            },
            label: stackInsideLabel(fmt1,"h"),
            data: master.map(x=>x.func_h)
          },
          {
            name:"Parado (h)",
            type:"bar",
            stack:"total",
            barWidth:"55%",
            itemStyle:{
              borderRadius: isLowPerf ? [6,6,0,0] : [10,10,0,0],
              color:"rgba(255,99,132,0.72)"
            },
            label: stackInsideLabel(fmt1,"h"),
            data: master.map(x=>x.parado_h)
          }
        ];
        return opt;
      }
    }
  ];
}

/* =========================
   PLAYER (N fontes x 5 telas)
========================= */
let chart=null;
let startT=0;
let screenIdx=0;

let DATA_BY_SOURCE = [];
let SCREENS = [];

function setHeader(){
  if(!SCREENS.length) return; // ‚úÖ PROTE√á√ÉO
  const s = SCREENS[screenIdx];
  elTitle.textContent = s.title;
  elMeta.textContent = `${screenIdx+1}/${SCREENS.length} ‚Ä¢ ${SOURCES.length} links ‚Ä¢ ${LAST_DAYS} dias`;
}

function render(){
  if(!SCREENS.length) return; // ‚úÖ PROTE√á√ÉO
  hideMsg();
  setHeader();
  chart.setOption(SCREENS[screenIdx].option(), true);
  startT=performance.now();
}

function tick(now){
  if(!SCREENS.length) return; // ‚úÖ PROTE√á√ÉO
  const remaining = INTERVAL_MS - (now - startT);
  const frac = Math.max(0, Math.min(1, remaining / INTERVAL_MS));
  elProg.style.transform = `scaleX(${frac})`;
  if(remaining<=0){
    screenIdx = (screenIdx+1) % SCREENS.length;
    render();
  }
  requestAnimationFrame(tick);
}

function next(){
  if(!SCREENS.length) return; // ‚úÖ PROTE√á√ÉO
  screenIdx = (screenIdx+1) % SCREENS.length;
  render();
}
function prev(){
  if(!SCREENS.length) return; // ‚úÖ PROTE√á√ÉO
  screenIdx = (screenIdx-1 + SCREENS.length) % SCREENS.length;
  render();
}
document.getElementById("next").addEventListener("click", next);
document.getElementById("prev").addEventListener("click", prev);

/* =========================
   BOOT
========================= */
(async ()=>{
  try{
    elTitle.textContent="Carregando dados (multi links)‚Ä¶";
    elMeta.textContent="Aguarde";

    DATA_BY_SOURCE = [];
    for(let i=0;i<SOURCES.length;i++){
      const m = await loadMasterFrom(SOURCES[i].csvUrl);
      DATA_BY_SOURCE.push(m);
    }

    SCREENS = [];
    for(let i=0;i<SOURCES.length;i++){
      SCREENS.push(...buildFiveScreensForSource(i));
    }

    if(!SCREENS.length){
      throw new Error("Nenhum dado carregado.");
    }

    chart = echarts.init(document.getElementById("chart"), null, {renderer:"canvas"});
    window.addEventListener("resize", ()=>chart.resize());

    render();
    requestAnimationFrame(tick);

    window.addEventListener("keydown", (e)=>{
      if(e.key==="ArrowRight" || e.key===" " || e.key==="PageDown") next();
      else if(e.key==="ArrowLeft" || e.key==="Backspace" || e.key==="PageUp") prev();
    });

  }catch(err){
    showMsg(
      "Erro ao carregar um ou mais links.\n\n" +
      "Verifique se TODOS os links s√£o CSV no formato /pub?‚Ä¶&output=csv\n" +
      "e se a aba est√° publicada.\n\n" +
      "Erro: " + err.message
    );
    elTitle.textContent="Erro";
    elMeta.textContent="Confira os links";
  }
})();
</script>
</body>
</html>
